---
title: "Predição da profundidade do solum"
author: "Horst"
date: "1 de novembro de 2017"
output:
  bookdown::word_document2:
    reference_docx: ../docs/template.docx
bibliography: biblio.bib
csl: abnt.csl
lang: pt
---

```{r, eval=FALSE, echo=FALSE}
rmarkdown::render('main.Rmd', encoding = 'UTF-8', output_dir = "../docs")
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Carregar os Pacotes
library(magrittr)
library(dplyr)
library(glue)
library(lattice)
library(latticeExtra)
library(georob)
library(sp)
library(mapview)
library(raster)
library(rmarkdown)
library(caret)

# Sistemas de referência de coordenadas (Fonte: http://spatialreference.org/ref/epsg/)
wgs84utm22s <- sp::CRS('+proj=utm +zone=22 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs')
sirgas2000 <- sp::CRS('+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs')

# Rampas de cores
col_soil_var <- topo.colors(100)
```


*Caracterização dos dados*

Os dados que utilizei para este trabalho são provenientes de um povoamento florestal de 108 ha de $Pinus taeda$ L. de 29 anos. A área pertence ao município de Campo Belo do Sul, região serrana do Estado de Santa Catarina, Brasil. O clima é do tipo Cfb, mesotérmico, subtropical úmido e com precipitação média de 1.647 mm com chuvas bem distribuídas no ano. A geologia regional é constituída por uma sequência vulcânica de rochas ácidas da Formação Serra Geral, com predomínio de riodacito.

Na área de estudo identificamos Neossolos Litólicos e Neossolos Regolíticos, Cambissolos Háplicos e Cambissolos Húmicos, Latossolos Vermelhos e Gleissolos Melânicos, os quais representam a topossequência clássica da área de estudo (Figura 1c). Conforme as tendências observadas, em locais de relevo plano ou suavemente ondulado com boa drenagem, estão solos profundos com sequência de horizontes A-Bw (Latossolos), em condições de má drenagem, ocorrem solos com a sequência de horizonte A-Cg (Gleissolos). Nos relevos ondulado ou fortemente ondulado, predominam solos rasos com a sequência de horizontes A ou A-Bi (Neossolos e Cambissolos).

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('../docs/figura1.png')
```
Figura 1. Localização da área de estudo no município de Campo Belo do Sul, Estado de Santa Catarina (SC), Brasil (a) e área ampliada com modelo digital de elevação e distribuição dos pontos amostrais (b). Relação da classe de solo e altura das árvores de uma Topossequência típica da área de estudo (c).


*Amostragem*

Definimos uma malha amostral contendo 102 pontos para coleta de dados (Figura 1 b). Os pontos foram alocados pelo algoritmo Hipercubo Latino Condicionado (Conditioned Latin Hipercube Sampling – cLHS) através da função $clhs()$ implementado no pacote **clhs**. Foram consideradas como variáveis condicionantes da amostragem ELEV, VD, TWI, CNBL e DECLI as quais, juntas, explicaram aproximadamente 86% da variância topográfica, identificada através da Análise de Componentes Principais (ACP).

Em cada ponto amostral medimos a profundidade do solum (PF) e a altura das árvores (h). Consideramos solum a espessura máxima do solo onde as raízes podem se desenvolver sem impedimentos físicos para penetração livre das raízes. Os fatores limitantes considerados foram o lençol freático elevado e o contato com rocha consolidada (contato lítico) com ou sem fissuras.
Para representar h utilizamos o valor médio dos quatro indivíduos de $Pinus taeda$ mais próximos de cada ponto amostral foram mensurados. Portanto, cada ponto de amostragem representa uma área (bloco) de aproximadamente 10 x 10 metros no campo.

```{r}
#Importar pontos
pontos <- read.csv('../data/GateadosDados.csv', dec = ".", sep= ";", stringsAsFactors = FALSE)

#transformar coord dos pontos
sp :: coordinates(pontos) <- c('X' , 'Y')
sp :: proj4string(pontos) <- wgs84utm22s #coordenada referencia
pontos <- sp :: spTransform(pontos, wgs84utm22s) #transforma coordenada para wgs84

pontos@data

```

```{r}
#normalidade profundidade
stats::shapiro.test(pontos$PFd)
raster::hist(pontos$PFd)

stats::shapiro.test(pontos$h)
graphics::hist(pontos$h)

```

PF bimodal
h normal

```{r}

par(mfrow=c(1,2))

##frequencia com linha normal
graphics::hist(pontos$PFd, breaks=10, xlab="", col="grey90", cex.axis=1,
          xlim=c(1,10),  ylim=c(0,37),ylab="",main=" ") 
    xfit<-base::seq(min(pontos$PFd),max(pontos$PFd), length=50) 
    yfit<-stats::dnorm(xfit,mean=mean(pontos$PFd),sd=sd(pontos$PFd))
   yfit<-  yfit*diff(ex$mids[1:2])*length(pontos$PFd) 
    lines(xfit, yfit, col="red", lwd=2) 
    mtext("Frequência",line=2.6, side=2, cex=1) 
    mtext("PF (dm)",line=2.6, side=1, cex=1) 
    graphics::rug((pontos$PFd), col="red")
     box()

##frequencia com linha normal
graphics::hist(pontos$h, breaks=10, xlab="", col="grey90", cex.axis=1,
          xlim=c(23,38),  ylim=c(0,16),ylab="",main="") 
    xfit<-base::seq(min(pontos$h),max(pontos$h), length=50) 
    yfit<-stats::dnorm(xfit,mean=mean(pontos$h),sd=sd(pontos$h))
   yfit<-  yfit*diff(ex$mids[1:2])*length(pontos$h) 
    lines(xfit, yfit, col="red", lwd=2) 
    mtext("Frequência",line=2.6, side=2, cex=1) 
    mtext("h (m)",line=2.6, side=1, cex=1) 
    graphics::rug((pontos$h), col="red")
     box()
     
```


Utilizei o MDE disponibilizado pelo Governo do Estado de SC - Secretaria de Estado do Desenvolvimento Econômico Sustentável, proveniente do Levantamento Aerofotogramétrico em 2010. Os dados, disponibilizados com resolução de 1 metro, foram reamostrados para 10 m utilizando a ferramenta $reamostragem$ no software SAGA GIS.

A partir do MDE foram derivadas 12 variáveis topográficas utilizando a ferramenta $Tarrain Analyses$ do software SAGA GIS.

```{r}
#Importar covars
ASP <- raster::raster("../data/Covars/ASP.tif")
CNBL <- raster::raster("../data/Covars/CNBL.tif")
DECLI <- raster::raster("../data/Covars/DECLI.tif")
ELEV <- raster::raster("../data/Covars/ELEV.tif")
LS <- raster::raster("../data/Covars/LS.tif")
PLC <- raster::raster("../data/Covars/PLC.tif")
RSP <- raster::raster("../data/Covars/RSP.tif")
TPI <- raster::raster("../data/Covars/TPI.tif")
TRI <- raster::raster("../data/Covars/TRI.tif")
TWI <- raster::raster("../data/Covars/TWI.tif")
VD <- raster::raster("../data/Covars/VD.tif")
VDCN <- raster::raster("../data/Covars/VDCN.tif")
RFPF <- raster::raster("../data/Covars/predictionPF.tif")
```


```{r}
#Extrair as covar (X e Y = nome das colunas)

pontos$ASP <- raster::extract(ASP,  pontos)
pontos$CNBL <- raster::extract(CNBL, pontos)
pontos$DECLI <- raster::extract(DECLI, pontos)
pontos$ELEV <- raster::extract(ELEV, pontos)
pontos$LS <- raster::extract(LS, pontos)
pontos$PLC <- raster::extract(PLC, pontos)
pontos$RSP <- raster::extract(RSP, pontos)
pontos$TPI <- raster::extract(TPI, pontos)
pontos$TRI <- raster::extract(TRI, pontos)
pontos$TWI <- raster::extract(TWI, pontos)
pontos$VD <- raster::extract(VD, pontos)
pontos$VDCN <- raster::extract(VDCN, pontos)
pontos$RFPF <- raster::extract(RFPF, pontos)
```

Para fins de ordenamento de produção, a área possui 12 parcelas fixas de inventário contínuo (PIC) de 500 metros quadrados cada que são utilizados na estimativa da produtividade local.

Cada PIC é classificada em função da média de altura das 100 árvores de maior perímetro basal da parcela, expressa como altura dominante (Hdom). Em função da Hdom e seus incrimentos anuais é estabelecido o índices de sítio (IS). Esse índice é então atribuido à todo o talhão.

As parcelas da área foram classificação em 4 níveis, em que 1 corresponde ao sítio com melhor produtividade (Figura 2).



```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('../docs/figura2.png')
```
Figura 2 - Área de estudo, com indicação da área produtiva e parcelas de inventário contínuo contento os índices de sítio e respectivos valores de altura dominante


Os níveis de produtividade foram atribuidos aos polígonos e, naquelas em que não existe parcela de PIC, o valor de sítio foi estimado com base na altura das árvores amostradas á campo e das PCIs vizinhas.

```{r}
#Importar shape da área (contorno)
pistola <- 
 raster::shapefile('../data/contorno/limite_projeto.shp',
                   stringsAsFactors = TRUE, encoding = 'UTF-8') %>%
sp::spTransform(wgs84utm22s)

#mapview::mapview(pistola)
```

```{r}
#Importar shape da produtividade do projeto pistola e transformar as coordenadas
#shape no pacote raster pela função shapefile
ProdutividadePistola <- 
 raster::shapefile('../data/Produtividade/ProdutividadePistola.shp',
                   stringsAsFactors = FALSE, encoding = 'UTF-8') %>%
 sp::spTransform(wgs84utm22s)

sp::spplot(ProdutividadePistola, main = "Mapa de índices de Sítio")
default.stringsAsFactors()
#mapview::mapview(ProdutividadePistola)
```

```{r}
#Amostragem do sitio
pontos$Sitio <- sp::over(x = pontos, y = ProdutividadePistola, na.omit = TRUE) %>% unlist()
#str(pontos)
#pontos@data
```

```{r}
pontos$Sitio <- as.factor(pontos@data$Sitio)
```

```{r}
#localização dos pontos
sp::spplot(
  ProdutividadePistola, scales = list(draw = T),
  main = 'Localização dos pontos') +
  lattice::xyplot(Y ~ X, data = as.data.frame(pontos@coords),
                  pch = 20, col = 'red', lwd = 2, cex = 1.5) %>%
latticeExtra::as.layer()
```


Predição por random forest
PFd ~ DECLI + ELEV + h

RMSE      Rsquared 
2.717759  0.4153228

```{r}
caret::modelLookup('rf')
```

```{r}
#Random Forest

form <- as.formula(paste("PFd~", paste(names(pontos)[c(12:24)], collapse="+"), collapse=""))
form


rf_fit <- caret::train(PFd ~ DECLI + ELEV, data = pontos@data,
  method = "rf", tuneLength = 1, importance = TRUE, trControl = trainControl("LOOCV"))
  
rf_fit
```

```{r}
pontos@data$rf <- rf_fit$finalModel$predicted
lm(PFd ~ rf, pontos@data) %>% plot()
```

```{r}
grid <- sp::spsample(pistola, 10000, type = 'regular')
plot(grid@coords, asp = 1)
```

```{r}
grid$rf <- raster::predict(rf_fit, grid)
sp::spplot(grid, 'rf')

```


```{r}
sp::spplot(RFPF, scales = list(draw = TRUE))
```

Parte I - Profundidade do solo

n = 102 observações para calibração + predição + validação (108 ha)
Validação: validação cruzada (leave-one-out)
Covariáveis: atributos de terreno com resolução espacial de 10 m + sítios (4 classes)
Suporte amostral de blocos (10 x 10 m)
Erro de medida


Krigagem ordinária pelo gstat:


```{r Variogram, fig.asp=1, fig.width=7, fig.height=7}

variograma <- gstat::variogram(PFd ~ 1, pontos)#, boundaries = limites)
plot(variograma, ylab = "Semivariância", xlab = "Distância (m)", pch = 20, cex = 1.5, plot.numbers = TRUE) #o parâmetro plot.numbers plota o número de pares de pontos)

vario<- georob::sample.variogram(PFd ~ 1,
    data= pontos, locations = ~ X + Y, lag.dist.def = limites) %>%
  plot()
```

```{r}
lags <- seq(0, 2500, length.out = 15)
georob::sample.variogram(
  PFd ~ 1, data = pontos, locations = ~ X + Y, lag.dist.def = lags,
  xy.angle.def = c(0, 22.5, 67.5, 112.5, 157.5, 180)) %>% 
  plot(type = "b")
```

Avaliada a evolução da semivariância nas diferentes direções, há evidência clara da existência de estruturas de autocorrelação espacial dependentes da direção.
O processo espacial é anisotrópico?

```{r AjusteVar, fig.asp=1}
#Encontrar uma função do semivariograma/de covariãncia que descrevam esse comportamento dos pontos:
# exponencial
# gaussiana
#efeito pepita puro ou puro ruido

#limites <- seq(0, 3000,length.out = 35)

#definir parametros iniciais
m_exp <- gstat::vgm(psill = 13 - 7, model = 'Exp', range = 15, nugget = 5)
m_exp <- gstat::fit.variogram(variograma, m_exp)

#criar espaço para figura
plot(variograma, m_exp, col.line = 'red', xlab = 'Distância (m)', ylab = 'Semivariância')

```


```{r}

#Criar o grid
grid <- sp::spsample(pistola, 10000, type = 'regular')
plot(grid@coords, asp = 1)

```

```{r}
#Mapa com valores preditos
mapa_exp <- gstat::krige(PFd ~ 1, pontos, grid, m_exp, debug.level = 1)
sp::gridded(mapa_exp) <- TRUE #grid passa a ser raster


sp::spplot(mapa_exp, 1, col.regions = col_soil_var)
```

```{r DesvP}
#Passar para desvio padrão CUIDADO PARA NÃO FAZER DUAS VEZES
mapa_exp$var1.var <- sqrt(mapa_exp$var1.var)

sp::spplot(mapa_exp, 2, col.regions = col_soil_var)
```


Krigagem  pelo georob

Modelo linear misto de variação espacial (georob)

Segundo esse modelo, os dados geoestatísticos são uma realização de um campo aleatório que podem ser descritos como a combinação aditiva de efeitos fixos, efeitos aleatórios e erro aleatório independente.

- Efeitos fixos: floresta aleatória
Predição espacial: suporte de blocos: 10x10 m e por talhão


```{r fig.asp=1}
limites <- seq(0, 3000,length.out = 35)

vario<- georob::sample.variogram(PFd ~ RFPF,
    data= pontos, locations = ~ X + Y, lag.dist.def = limites) %>%
  plot()

```







```{r fig.asp=1}
#krigagem universal

reml_fit <- georob::georob(
  PFd ~ RFPF + DECLI + VDCN, data = pontos, locations = ~ X + Y, 
  variogram.model = 'RMexp', 
  param = c(variance = 10, 
            nugget = 5, 
            scale = 15),
  tuning.psi = 1000)


plot(vario)
lines(reml_fit)
```

```{r}
#Mapa com valores preditos
mapa_exp <- gstat::krige(PFd ~ RFPF + DECLI + VDCN, pontos, grid, m_exp, debug.level = 1)
sp::gridded(mapa_exp) <- TRUE #grid passa a ser raster


sp::spplot(mapa_exp, 1, col.regions = col_soil_var)
```

```{r}
#código de predição via georob... não lembro, mas acho que não tem a espacialização aí

grid <- sp::spsample(dnos_in, 10000, type = 'regular')

```





#luciano

```{r}

colnames(grid@coords) <- colnames(dnos_in@coords)
pred_ponto <- predict(
  reml_fit, newdata = grid, type = 'signal', signif = 0.95,
  control = georob::control.predict.georob(extended.output = TRUE))
sp::gridded(pred_ponto) <- TRUE
str(pred_ponto)
```

```{r}
at <- pred_ponto@data[, c("pred", "lower", "upper")] %>% range()
at <- seq(at[1], at[2], length.out = 20)
sp::spplot(pred_ponto, zcol = c("lower", "pred", "upper"), at = at, main = "prediction")
```

```{r}
sp::spplot(pred_ponto, zcol = 'se')
```

Validação cruzada do modelo utilizando apenas krigagem ordinária.

```{r}
validacao <- georob::cv(reml_fit, nset = 375)
summary(validacao)
```

```{r}
1 - sum((validacao$pred$data - validacao$pred$pred)^2) / 
  sum((validacao$pred$data - mean(validacao$pred$data))^2)

plot(validacao)
```
```

```{r}
as.formula(paste("h~",paste(names(pontos)[c(11:30)], collapse="+"), collapse=""))

lm_fit <- lm(h ~ Sitio, pontos)

summary(lm_fit)
#pontos@data
```

```{r}
op <- par(mfrow = c(2, 2))
plot(lm_fit, which = 1:4, cex = 1.5, lwd = 1.5)
par(op)
```

